THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=!0,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){function t(){ye.setRGB(0,0,0),xe.setRGB(0,0,0),ue.setRGB(0,0,0);for(var e=0,t=T.length;e<t;e++){var i=T[e],r=i.color;i.isAmbientLight?ye.add(r):i.isDirectionalLight?xe.add(r):i.isPointLight&&ue.add(r)}}function i(e,t,i){for(var r=0,o=T.length;r<o;r++){var n=T[r];if(ne.copy(n.color),n.isDirectionalLight){var a=ge.setFromMatrixPosition(n.matrixWorld).normalize(),s=t.dot(a);if(s<=0)continue;s*=n.intensity,i.add(ne.multiplyScalar(s))}else if(n.isPointLight){var a=ge.setFromMatrixPosition(n.matrixWorld),s=t.dot(ge.subVectors(a,e).normalize());if(s<=0)continue;if(0==(s*=0==n.distance?1:1-Math.min(e.distanceTo(a)/n.distance,1)))continue;s*=n.intensity,i.add(ne.multiplyScalar(s))}}}function r(e,t,i){f(i.opacity),h(i.blending);var r=t.scale.x*b,o=t.scale.y*L,n=Math.sqrt(r*r+o*o);if(ve.min.set(e.x-n,e.y-n),ve.max.set(e.x+n,e.y+n),i.isSpriteMaterial){var a=i.map;if(null!==a){var s=ae[a.id];if(void 0!==s&&s.version===a.version||(s=c(a),ae[a.id]=s),void 0!==s.canvas){x(s.canvas);var l=a.image,p=l.width*a.offset.x,d=l.height*a.offset.y,m=l.width*a.repeat.x,E=l.height*a.repeat.y,v=r/m,u=o/E;V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.translate(-r/2,-o/2),V.scale(v,u),V.translate(-p,-d),V.fillRect(p,d,m,E),V.restore()}}else x(i.color.getStyle()),V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.scale(r,-o),V.fillRect(-.5,-.5,1,1),V.restore()}else i.isSpriteCanvasMaterial?(y(i.color.getStyle()),x(i.color.getStyle()),V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.scale(r,o),i.program(V),V.restore()):i.isPointsMaterial&&(x(i.color.getStyle()),V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.scale(r*i.size,-o*i.size),V.fillRect(-.5,-.5,1,1),V.restore())}function o(e,t,i,r){if(f(r.opacity),h(r.blending),V.beginPath(),V.moveTo(e.positionScreen.x,e.positionScreen.y),V.lineTo(t.positionScreen.x,t.positionScreen.y),r.isLineBasicMaterial){if(m(r.linewidth),E(r.linecap),v(r.linejoin),r.vertexColors!==THREE.VertexColors)y(r.color.getStyle());else{var o=i.vertexColors[0].getStyle(),n=i.vertexColors[1].getStyle();if(o===n)y(o);else{try{var a=V.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,o),a.addColorStop(1,n)}catch(e){a=o}y(a)}}r.isLineDashedMaterial&&u([r.dashSize,r.gapSize]),V.stroke(),ve.expandByScalar(2*r.linewidth),r.isLineDashedMaterial&&u([])}}function n(e,t,r,o,n,c,d,m){if(g.info.render.vertices+=3,g.info.render.faces++,f(m.opacity),h(m.blending),X=e.positionScreen.x,Y=e.positionScreen.y,Z=t.positionScreen.x,_=t.positionScreen.y,ee=r.positionScreen.x,te=r.positionScreen.y,a(X,Y,Z,_,ee,te),(m.isMeshLambertMaterial||m.isMeshPhongMaterial||m.isMeshStandardMaterial)&&null===m.map)re.copy(m.color),oe.copy(m.emissive),m.vertexColors===THREE.FaceColors&&re.multiply(d.color),ie.copy(ye),Se.copy(e.positionWorld).add(t.positionWorld).add(r.positionWorld).divideScalar(3),i(Se,d.normalModel,ie),ie.multiply(re).add(oe),!0===m.wireframe?s(ie,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):l(ie);else if(m.isMeshBasicMaterial||m.isMeshLambertMaterial||m.isMeshPhongMaterial||m.isMeshStandardMaterial)if(null!==m.map){var E=m.map.mapping;E===THREE.UVMapping&&(se=d.uvs,p(X,Y,Z,_,ee,te,se[o].x,se[o].y,se[n].x,se[n].y,se[c].x,se[c].y,m.map))}else null!==m.envMap?m.envMap.mapping===THREE.SphericalReflectionMapping&&(Re.copy(d.vertexNormalsModel[o]).applyMatrix3(Te),le=.5*Re.x+.5,ce=.5*Re.y+.5,Re.copy(d.vertexNormalsModel[n]).applyMatrix3(Te),pe=.5*Re.x+.5,de=.5*Re.y+.5,Re.copy(d.vertexNormalsModel[c]).applyMatrix3(Te),fe=.5*Re.x+.5,he=.5*Re.y+.5,p(X,Y,Z,_,ee,te,le,ce,pe,de,fe,he,m.envMap)):(ie.copy(m.color),m.vertexColors===THREE.FaceColors&&ie.multiply(d.color),!0===m.wireframe?s(ie,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):l(ie));else m.isMeshNormalMaterial?(Re.copy(d.normalModel).applyMatrix3(Te),ie.setRGB(Re.x,Re.y,Re.z).multiplyScalar(.5).addScalar(.5),!0===m.wireframe?s(ie,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):l(ie)):(ie.setRGB(1,1,1),!0===m.wireframe?s(ie,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):l(ie))}function a(e,t,i,r,o,n){V.beginPath(),V.moveTo(e,t),V.lineTo(i,r),V.lineTo(o,n),V.closePath()}function s(e,t,i,r){m(t),E(i),v(r),y(e.getStyle()),V.stroke(),ve.expandByScalar(2*t)}function l(e){x(e.getStyle()),V.fill()}function c(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(!1===t.complete)return{canvas:void 0,version:0};var i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,r=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,o=e.wrapS===THREE.MirroredRepeatWrapping,n=e.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=t.width*(o?2:1),a.height=t.height*(n?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,t.height),s.drawImage(t,0,0),!0===o&&(s.setTransform(-1,0,0,-1,t.width,t.height),s.drawImage(t,-t.width,0)),!0===n&&(s.setTransform(1,0,0,1,0,0),s.drawImage(t,0,t.height)),!0===o&&!0===n&&(s.setTransform(-1,0,0,1,t.width,0),s.drawImage(t,-t.width,t.height));var l="no-repeat";!0===i&&!0===r?l="repeat":!0===i?l="repeat-x":!0===r&&(l="repeat-y");var c=V.createPattern(a,l);return e.onUpdate&&e.onUpdate(e),{canvas:c,version:e.version}}function p(e,t,i,r,o,n,a,s,l,p,d,f,h){var m=ae[h.id];if(void 0!==m&&m.version===h.version||(m=c(h),ae[h.id]=m),void 0===m.canvas)return x("rgba( 0, 0, 0, 1)"),void V.fill();x(m.canvas);var E,v,y,u,g,S,R,T,w=h.offset.x/h.repeat.x,M=h.offset.y/h.repeat.y,C=h.image.width*h.repeat.x,H=h.image.height*h.repeat.y;a=(a+w)*C,s=(s+M)*H,l=(l+w)*C,p=(p+M)*H,d=(d+w)*C,f=(f+M)*H,i-=e,r-=t,o-=e,n-=t,l-=a,p-=s,d-=a,f-=s,0!==(R=l*f-d*p)&&(T=1/R,E=(f*i-p*o)*T,v=(f*r-p*n)*T,y=(l*o-d*i)*T,u=(l*n-d*r)*T,g=e-E*a-y*s,S=t-v*a-u*s,V.save(),V.transform(E,v,y,u,g,S),V.fill(),V.restore())}function d(e,t,i){var r=t.x-e.x,o=t.y-e.y,n=r*r+o*o,a;0!==n&&(a=i/Math.sqrt(n),r*=a,o*=a,t.x+=r,t.y+=o,e.x-=r,e.y-=o)}function f(e){O!==e&&(V.globalAlpha=e,O=e)}function h(e){k!==e&&(e===THREE.NormalBlending?V.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?V.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?V.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(V.globalCompositeOperation="multiply"),k=e)}function m(e){I!==e&&(V.lineWidth=e,I=e)}function E(e){G!==e&&(V.lineCap=e,G=e)}function v(e){U!==e&&(V.lineJoin=e,U=e)}function y(e){A!==e&&(V.strokeStyle=e,A=e)}function x(e){F!==e&&(V.fillStyle=e,F=e)}function u(e){q.length!==e.length&&(V.setLineDash(e),q=e)}console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var g=this,S,R,T,w=new THREE.Projector,M=void 0!==e.canvas?e.canvas:document.createElement("canvas"),C=M.width,H=M.height,b=Math.floor(C/2),L=Math.floor(H/2),B=0,P=0,z=C,W=H,j=1,V=M.getContext("2d",{alpha:!0===e.alpha}),D=new THREE.Color(0),N=!0===e.alpha?0:1,O=1,k=0,A=null,F=null,I=null,G=null,U=null,q=[],J,K,Q,X,Y,Z,_,ee,te,ie=new THREE.Color,re=new THREE.Color,oe=new THREE.Color,ne=new THREE.Color,ae={},se,le,ce,pe,de,fe,he,me=new THREE.Box2,Ee=new THREE.Box2,ve=new THREE.Box2,ye=new THREE.Color,xe=new THREE.Color,ue=new THREE.Color,ge=new THREE.Vector3,Se=new THREE.Vector3,Re=new THREE.Vector3,Te=new THREE.Matrix3;void 0===V.setLineDash&&(V.setLineDash=function(){}),this.domElement=M,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.getContext=function(){return V},this.getContextAttributes=function(){return V.getContextAttributes()},this.getPixelRatio=function(){return j},this.setPixelRatio=function(e){void 0!==e&&(j=e)},this.setSize=function(e,t,i){C=e*j,H=t*j,M.width=C,M.height=H,b=Math.floor(C/2),L=Math.floor(H/2),!1!==i&&(M.style.width=e+"px",M.style.height=t+"px"),me.min.set(-b,-L),me.max.set(b,L),Ee.min.set(-b,-L),Ee.max.set(b,L),O=1,k=0,A=null,F=null,I=null,G=null,U=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,r){B=e*j,P=t*j,z=i*j,W=r*j},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){D.set(e),N=void 0!==t?t:1,Ee.min.set(-b,-L),Ee.max.set(b,L)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return D},this.getClearAlpha=function(){return N},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===Ee.isEmpty()&&(Ee.intersect(me),Ee.expandByScalar(2),Ee.min.x=Ee.min.x+b,Ee.min.y=-Ee.min.y+L,Ee.max.x=Ee.max.x+b,Ee.max.y=-Ee.max.y+L,N<1&&V.clearRect(0|Ee.min.x,0|Ee.max.y,Ee.max.x-Ee.min.x|0,Ee.min.y-Ee.max.y|0),N>0&&(f(1),h(THREE.NormalBlending),x("rgba("+Math.floor(255*D.r)+","+Math.floor(255*D.g)+","+Math.floor(255*D.b)+","+N+")"),V.fillRect(0|Ee.min.x,0|Ee.max.y,Ee.max.x-Ee.min.x|0,Ee.min.y-Ee.max.y|0)),Ee.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,i){if(void 0===i.isCamera)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");var a=e.background;a&&a.isColor?(f(1),h(THREE.NormalBlending),x(a.getStyle()),V.fillRect(0,0,C,H)):!0===this.autoClear&&this.clear(),g.info.render.vertices=0,g.info.render.faces=0,V.setTransform(z/C,0,0,-W/H,B,H-P),V.translate(b,L),S=w.projectScene(e,i,this.sortObjects,this.sortElements),R=S.elements,T=S.lights,Te.getNormalMatrix(i.matrixWorldInverse),t();for(var s=0,l=R.length;s<l;s++){var c=R[s],p=c.material;if(void 0!==p&&0!==p.opacity){if(ve.makeEmpty(),c instanceof THREE.RenderableSprite)J=c,J.x*=b,J.y*=L,r(J,c,p);else if(c instanceof THREE.RenderableLine)J=c.v1,K=c.v2,J.positionScreen.x*=b,J.positionScreen.y*=L,K.positionScreen.x*=b,K.positionScreen.y*=L,ve.setFromPoints([J.positionScreen,K.positionScreen]),!0===me.intersectsBox(ve)&&o(J,K,c,p);else if(c instanceof THREE.RenderableFace){if(J=c.v1,K=c.v2,Q=c.v3,J.positionScreen.z<-1||J.positionScreen.z>1)continue;if(K.positionScreen.z<-1||K.positionScreen.z>1)continue;if(Q.positionScreen.z<-1||Q.positionScreen.z>1)continue;J.positionScreen.x*=b,J.positionScreen.y*=L,K.positionScreen.x*=b,K.positionScreen.y*=L,Q.positionScreen.x*=b,Q.positionScreen.y*=L,p.overdraw>0&&(d(J.positionScreen,K.positionScreen,p.overdraw),d(K.positionScreen,Q.positionScreen,p.overdraw),d(Q.positionScreen,J.positionScreen,p.overdraw)),ve.setFromPoints([J.positionScreen,K.positionScreen,Q.positionScreen]),!0===me.intersectsBox(ve)&&n(J,K,Q,0,1,2,c,p)}Ee.union(ve)}}V.setTransform(1,0,0,1,0,0)}};